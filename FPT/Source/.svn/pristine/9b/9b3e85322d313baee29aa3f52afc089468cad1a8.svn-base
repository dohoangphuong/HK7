@model CSS.ViewModels.SearchDealerModel

@{
    Layout = null;
}
@Scripts.Render("~/bundles/jqueryvalidate")
<script type="text/javascript">
    $(document).ready(function () {
        $.ajax({
            type: "POST",
            url: "/Dealer/GetAllDealer",
            success: function (result) {
                $("#srchDealerResult").html(result);
            },
            error: function () {
                alert("Call ajax failed.");
            }
        });
        var listAdd = [];
        var listDelete = [];
        $("#btnAddDealer").click(function () {
            var selectedDealers = $('#tbSearchDealerResult input:checked');
            if (selectedDealers.length == 0)
                alert("Please select at least one dealer to add.");
            else {
                selectedDealers.each(function () {
                    var row = $(this).closest('tr');
                    if (row.length > 0) {
                        var existRow = $("#tbSelectedDealer tbody #" + this.value);
                        if (existRow.length == 0) {
                            $("#tbSelectedDealer tbody").append("<tr id='" + this.value + "'>" + row.html() + "</tr>");
                            var index = listDelete.indexOf(this.value);
                            if (index >= 0)
                                listDelete.splice(index, 1);
                            else {
                                if (listAdd.indexOf(this.value) < 0)
                                    listAdd.push(this.value);
                            }
                        }
                        else {
                            alert("Dealer has code: " + this.value + " is exist in Selected Dealer List");
                        }
                    }
                });
            }
        });
        $("#btnRemoveDealer").click(function () {
            var selectedDealers = $('#tbSelectedDealer input:checked');
            if (selectedDealers.length == 0)
                alert("Please select at least one dealer to remove.");
            else {
                selectedDealers.each(function () {
                    $(this).closest('tr').remove();
                    var index = listAdd.indexOf(this.value);
                    if (index >= 0)
                        listAdd.splice(index, 1);
                    else
                        listDelete.push(this.value);
                });
                alert(listAdd);
                alert(listDelete);
            }
        });
        $("#ajaxSaveDealers").click(function () {
            var rows = $("#tbSelectedDealer > tbody > tr");
            if (rows.length == 0)
                alert("Please select at least one dealer");
            else {
                var agrmtNumber = $("#agrmtNumber").val();
                var varNumber = $("#varNumber").val();
                $.ajax({
                    type: "POST",
                    url: "/Dealer/SaveDealers",
                    traditional: true,
                    data: {
                        dealersAdd: listAdd,
                        dealersDelete: listDelete,
                        agreementNumber: agrmtNumber,
                        varriantNumber: varNumber
                    },
                    success: function (result) {
                        $("#divMessage").html(result);
                        updateStatusAsChange();
                        listAdd = [];
                        listDelete = [];
                    },
                    error: function () {
                        alert("Call ajax failed.");
                    }
                });
            }
        });
    });
</script>

@using (Ajax.BeginForm("SearchDealer", "Dealer", null
    , new AjaxOptions()
    {
        HttpMethod = "POST",
        UpdateTargetId = "srchDealerResult"
    }, new { @style = "height: 100%" }))
{
    @Html.AntiForgeryToken();
    @Html.HiddenFor(model => model.AgreementNumber, new { @id = "agrmtNumber" });
    @Html.HiddenFor(model => model.VarriantNumber, new { @id = "varNumber" });

    <div class="form-horizontal" style="height: 25%">
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        <div class="form-group" style="margin:5px">
            @Html.LabelFor(model => model.Code, htmlAttributes: new { @class = "control-label col-md-2" })
            @Html.TextBoxFor(model => model.Code, new { htmlAttributes = new { @class = "form-control" } })
            @Html.ValidationMessageFor(model => model.Code, "", new { @class = "text-danger" })
        </div>
        <div class="form-group" style="margin:5px">
            @Html.LabelFor(model => model.DealerName, htmlAttributes: new { @class = "control-label col-md-2" })
            @Html.EditorFor(model => model.DealerName, new { htmlAttributes = new { @class = "form-control" } })
            @Html.ValidationMessageFor(model => model.DealerName, "", new { @class = "text-danger" })
        </div>
        <div class="col-md-offset-2 col-md-6">
            <input type="submit" value="Search" class="btn btn-default col-md-2">
        </div>
    </div>

    <div id="srchDealerResult" style="height: 30%; overflow-y:scroll"></div>
    <br />
    <div style="height:10%">
        <input id="btnAddDealer" type="button" class="btn btn-default" value="Add to Selected List" />
        <input id="btnRemoveDealer" type="button" class="btn btn-default" value="Remove from Selected List" />
    </div>

    <p style="font-weight:bold; height:3%">Selected Dealers</p>
    <div id="selectedDealer" style="height: 20%; overflow-y:scroll">
        <table id="tbSelectedDealer" class="table table-striped">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>DealerName</th>
                    <th>Town</th>
                    <th>County</th>
                    <th>select</th>
                </tr>
            </thead>
            <tbody>
                @{
    if (@Model.ListDealer != null)
    {
        foreach (var item in @Model.ListDealer)
        {
            <tr id="@item.Code">
                <td>@Html.DisplayFor(modelItem => item.Code)</td>
                <td>@Html.DisplayFor(modelItem => item.DealerName)</td>
                <td>@Html.DisplayFor(modelItem => item.Town)</td>
                <td>@Html.DisplayFor(modelItem => item.County)</td>
                <td>@Html.CheckBoxFor(modelItem => item.IsSelected, new { @value = item.Code })</td>
            </tr>
        }
    }
                }
            </tbody>
        </table>
    </div>


    <div class="actionBar" style="height: 10%">
        <input class="buttonNext" type="button" value="next" onclick="forward()" />
        <input class="buttonPrevious" type="button" value="back" onclick="backward()" />
        <input id="ajaxSaveDealers" class="buttonFinish" type="button" value="save as draft" />
    </div>
}
